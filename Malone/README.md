# Wireless IO

- [Wireless IO](#wireless-io)
  - [更新说明](#更新说明)
  - [简介](#简介)
  - [功能](#功能)
  - [使用方式](#使用方式)
  - [关键点](#关键点)
  - [测试项目](#测试项目)
  - [测试说明](#测试说明)
  - [函数说明](#函数说明)
  - [存在问题](#存在问题)

## 更新说明

| Date       | Author | Note          | Version number |
| ---------- | ------ | ------------- | -------------- |
| 2022.03.17 | LHC    | First edition | V1.0.0         |


## 简介

无线IO控制板，分为 ``Master`` 和 ``Slave`` 两个部分,主要用于以下几种场景:
> - ``Master`` 的外部信号接通，映射到对应的 ``Slave`` 的数字量或者模拟量动作。
> - ``Master`` 先请求 ``Slave1``的外部信号，``Slave2`` 执行 ``Master ``发送的 ``Slave1``的控制信号。


## 功能

- ``Master`` 负责收集外部的数字量和模拟量，组合成对应关系后执行自身控制同时，转发数据到目标 ``Slave``。
- ``Slave`` 负责接收来自``Master``的消息并作出响应，同时控制自身信号动作，有时也需要把某一些特殊消息传回给 ``Master``。


## 使用方式

- 注意主机与从机(**MCU与模块间**)配对使用 。
- 关于序列号说明：
> - 以``SN``开头，其中首个字母``M0``或者``S1``对应的是分别表示``Slave``和``Master``。
> - 接下来连续六个数据，例如：**202203** 表示本批次产品出厂日期为``2022年3月份``。
> - 最后四位数据表示，例如``0001``表示该设备距离第一次上市设备的累加编号。


## 关键点

- 硬件部分：
	- 主机：
      - 看门狗电路在下载时会导致下载失败，必须打开下载器**对MCU**供电。
	- 从机：
    	- 看门狗电路在下载时会导致下载失败，必须去掉三级管**Q1**,**J2**座子极性相反。
	- LoRa模块：
    	- 型号为：**WH-L102-L-P**(单帧数据不超过``256``字节，超过部分将**不发送**)。
    	- 推荐后续型号：**L101-L-P-H10**(串口最大缓存 ``1K`` 字节，若单包超过 ``250`` 字节长度，模块对该包进行分包处理。)。


- 软件部分：
	- **Master** 数据帧编号规则：
  
    | Addr(2B) | Channel(1B) | Modbus(xB) |
    | -------- | ----------- | ---------- |
    | 0x0000   | 0x00        | @fun       |

    - **Slave** 数据帧编号规则：
  
    | Addr(2B) | Channel(1B) | Modbus(xB) |
    | -------- | ----------- | ---------- |
    | 1~65535  | 1~127       | @fun       |

    - **Master** 寄存器映射规则：
  
    | 寄存器组         | 映射对象 | 地址范围      | 操作类型 |
    | ---------------- | -------- | ------------- | -------- |
    | Coil             | 数字量   | 00001 - 09999 | R/W      |
    | InputCoil        | 数字量   | 10001 - 19999 | R        |
    | Input Register   | 模拟量   | 30001 - 39999 | R        |
    | Holding Register | 模拟量   | 40001 - 49999 | R/W      |

    - **Slave** 寄存器映射规则：
  
    | 寄存器组         | 映射对象 | 地址范围      | 操作类型 | 规则       |
    | ---------------- | -------- | ------------- | -------- | ---------- |
    | Coil             | 数字量   | 00001 - 09999 | R/W      | 遵循Master |
    | InputCoil        | 数字量   | 10001 - 19999 | R        | 遵循Master |
    | Input Register   | 模拟量   | 30001 - 39999 | R        | 遵循Master |
    | Holding Register | 模拟量   | 40001 - 49999 | R/W      | 遵循Master |

    - 说明：目前应用场景比较简单，Master 与 Slave 的映射规则简单，但是并不和谐(牛头对在马嘴上)。
    - 调度算法说明：[CSDN博客](https://blog.csdn.net/weixin_42651067/article/details/123435613)

## 测试项目

- **Master** 和 **Slave** 间数字量对应关系。
- **Shell** 后台软件设置**LoRa**设备的目标参数。

## 测试说明

- LoRa模块点对点通信最远达**800**m(在速度等级为：**1**,持续**运行**模式,不加**前向纠错**时)。
- 开阔地带距离测试并不完善(当天同事并未带手机，中途导致主机天线跌落地面，测试距离有限)。


## 函数说明

- 暂略。


## 存在问题

- 模拟量部分并未做适配。
- 模块与MCU间，目前仅支持一对一绑定。
- 对于``LoRa``模块的参数配置不够便捷。
- ``Slave`` 上没有任何指示灯，测试时麻烦(例如：不知道是否接通电源、MCU是否工作)。
- 对于使用``shell``配置``L102``模块：
  - 使用直接调用``at 0 ``或者`` at 1``方式，特别容易卡死在``configASSERT( ( portNVIC_INT_CTRL_REG & portVECTACTIVE_MASK ) == 0 )``。
  - 在``AT``任务中调用，和直接调用两种多次连续操作后都会导致``DMA``接收``L102``发送回来数据失败。
- 数据接收失败原因：串口接收``DMA``中断优先级受``Freertos``管理，接收期间几轮过后，接收数据被滞后，导致解析失败。[关键原因：``uwTick``是``uint32_t``类型，但是接收端使用了``uint16_t``类型，导致失败]